# {{node_name}}

{{description}}

## Quick Reference

| Item | Value |
|------|-------|
| Type | Rust |
| Build | `cargo build --release` |
| Run | `bubbaloop node start {{node_name}}` |
| Logs | `bubbaloop node logs {{node_name}} -f` |

## File Structure

```
{{node_name}}/
├── AGENTS.md       # This file - AI agent context
├── node.yaml       # Daemon manifest (name, type, command)
├── config.yaml     # Runtime configuration
├── Cargo.toml      # Rust dependencies
└── src/
    ├── main.rs     # Entry point (CLI args, shutdown handling)
    └── node.rs     # Main implementation (EDIT THIS)
```

## How to Modify

### Adding a New Zenoh Publisher
Edit `src/node.rs`:
```rust
// Topics follow scoped pattern: bubbaloop/{scope}/{machine_id}/{{node_name}}/{resource}
// The topic_prefix is built automatically from BUBBALOOP_SCOPE and BUBBALOOP_MACHINE_ID
let my_topic = format!("{}/my_topic", topic_prefix);
let publisher = session.declare_publisher(&my_topic).await?;

// In the run loop, publish data
publisher.put(serde_json::to_vec(&data)?).await?;
```

### Adding a Subscriber
```rust
// Subscribe using scoped pattern (wildcards discover across machines)
let subscriber = session.declare_subscriber("bubbaloop/**/other_node/output").await?;
// Handle in select! loop
```

### Changing Configuration
Edit `config.yaml`:
```yaml
publish_topic: "output"  # Appended to bubbaloop/{scope}/{machine_id}/{{node_name}}/
rate_hz: 10.0  # Adjust publish rate
```

## Zenoh Topics

All topics follow the scoped pattern: `bubbaloop/{scope}/{machine_id}/{{node_name}}/{resource}`

| Topic Suffix | Direction | Format | Description |
|--------------|-----------|--------|-------------|
| `output` | Publish | JSON/Protobuf | Main output data |
| `schema` | Queryable | Protobuf | FileDescriptorSet (REQUIRED for protobuf nodes) |
| `manifest` | Queryable | JSON | Node self-description contract |
| `health` | Queryable | JSON | Node health status |
| `config` | Queryable | JSON | Read-only configuration |

Data published to these topics is:
- Visible in the Bubbaloop Dashboard
- Available to other nodes on the Zenoh network
- Persisted if a recorder node is running

### Schema Contract (Protobuf Nodes)

If this node publishes protobuf messages, it **MUST** serve its schema:

1. **Add protos directory** with your .proto files + `header.proto`:
   ```
   {{node_name}}/
   ├── protos/
   │   ├── header.proto      # Copy from bubbaloop-schemas
   │   └── {{node_name}}.proto
   ├── build.rs               # Compiles descriptor.bin
   └── src/
       └── node.rs
   ```

2. **Create build.rs** to compile descriptor.bin:
   ```rust
   fn main() {
       let out_dir = std::path::PathBuf::from(std::env::var("OUT_DIR").unwrap());
       prost_build::Config::new()
           .file_descriptor_set_path(out_dir.join("descriptor.bin"))
           .compile_protos(
               &["protos/{{node_name}}.proto", "protos/header.proto"],
               &["protos/"]
           ).unwrap();
   }
   ```

3. **Declare schema queryable** in `src/node.rs`:
   ```rust
   pub const DESCRIPTOR: &[u8] = include_bytes!(concat!(env!("OUT_DIR"), "/descriptor.bin"));

   let schema_queryable = session
       .declare_queryable(format!("{}/schema", topic_prefix))
       .await?;

   // In select! loop, handle queries:
   Ok(query) = schema_queryable.recv_async() => {
       query.reply(query.key_expr().clone(), DESCRIPTOR).await?;
   }
   ```

4. **NEVER use `.complete(true)`** — it blocks wildcard schema discovery.

See `ARCHITECTURE.md` for full schema contract details.

## Dependencies

This node has no dependencies on other nodes. To add dependencies, specify in `node.yaml`:
```yaml
depends_on:
  - other-node-name
```
