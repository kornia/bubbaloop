[workspace]
name = "bubbaloop"
version = "0.0.1"
description = "Multi-camera RTSP streaming with ROS-Z"
authors = ["Edgar Riba <edgar.riba@gmail.com>"]
channels = ["conda-forge"]
platforms = ["linux-64", "linux-aarch64"]

[activation]
scripts = ["scripts/activate.sh"]

[tasks]
# Launch all services (bridge, cameras, dashboard)
up = "process-compose -f process-compose.yaml up"

# build all nodes
build = "cargo build --release"

# development
check = "cargo check"
test = "cargo test"
fmt = "cargo fmt --all"
fmt-check = "cargo fmt --all -- --check"
clippy = "cargo clippy --all-targets --all-features -- -D warnings"
lint = { depends-on = ["fmt-check", "clippy"] }
pre-commit-install = "pre-commit install"
pre-commit-run = "pre-commit run --all-files"

# documentation
docs = "mkdocs serve"
docs-build = "mkdocs build"

# individual nodes
# Daemon manages all nodes via systemd and Zenoh
daemon = "RUST_LOG=info cargo run --bin bubbaloop --package bubbaloop --release -- daemon"

# Cameras connects to local zenohd by default (tcp/127.0.0.1:7447)
# Override with: pixi run cameras -- -z tcp/other:7447
cameras = "RUST_LOG=info cargo run --bin cameras_node --package rtsp_camera --release --"
inference = "RUST_LOG=debug cargo run --bin inference_node --package inference --release"
openmeteo = "RUST_LOG=info cargo run --bin openmeteo_node --package openmeteo --release --"

# Dashboard
dashboard-install = "cd dashboard && npm install"
dashboard-proto = { cmd = "cd dashboard && npm run proto", depends-on = ["dashboard-install"] }
dashboard-build = { cmd = "cd dashboard && npm run build", depends-on = ["dashboard-proto"] }
dashboard = { cmd = "cd dashboard && npm run dev", depends-on = ["dashboard-proto"] }

# TUI (Rust)
tui = "RUST_LOG=info cargo run --bin bubbaloop --package bubbaloop --release -- tui"

# TUI (Legacy Ink - deprecated)
bubbaloop-legacy-install = "cd bubbaloop-tui && npm install"
bubbaloop-legacy = { cmd = "cd bubbaloop-tui && npm run dev", depends-on = ["bubbaloop-legacy-install"] }

# Zenoh bridge (for dashboard WebSocket connection)
bridge-clone = "test -d zenoh-ts || git clone https://github.com/eclipse-zenoh/zenoh-ts.git"
bridge-build = { cmd = "cd zenoh-ts/zenoh-bridge-remote-api && cargo build --release", depends-on = ["bridge-clone"] }
bridge = { cmd = "zenoh-ts/target/release/zenoh-bridge-remote-api --listen tcp/0.0.0.0:7447 --ws-port 10000", depends-on = ["bridge-build"] }

# Zenoh client router (connects to remote server, uses config from TUI)
# Run `/server` in TUI first to configure the server endpoint
zenohd-client = "zenohd -c ~/.bubbaloop/zenoh.cli.json5"

[dependencies]
# Rust toolchain
rust = ">=1.75"

# GLib/GIO (required by gstreamer-rs)
glib = ">=2.56"

# GStreamer core and plugins
gstreamer = ">=1.22"
gst-plugins-base = ">=1.22"
gst-plugins-good = ">=1.22"
gst-plugins-bad = ">=1.22"      # Contains h264parse
gst-plugins-ugly = ">=1.22"     # Contains x264enc
gst-libav = ">=1.22"            # Contains avdec_h264

# Build dependencies
pkg-config = ">=0.29"
cmake = ">=3.20"
zlib = ">=1.2"
protobuf = ">=3.20"          # protoc compiler for prost-build

# Documentation
mkdocs-material = ">=9.0"

# Development tools
pre-commit = ">=3.0"
process-compose = ">=1.0"

# Dashboard
nodejs = ">=20"
