[workspace]
name = "bubbaloop"
version = "0.1.0"
description = "Multi-camera RTSP streaming with ROS-Z and Foxglove"
authors = ["Edgar Riba <edgar.riba@gmail.com>"]
channels = ["conda-forge"]
platforms = ["linux-64", "linux-aarch64"]

[activation]
scripts = ["scripts/activate.sh"]

[tasks]
build = "cargo build --release"
multicam = "RUST_LOG=info cargo run --bin multicam --release"
check = "cargo check"
test = "cargo test"
fmt = "cargo fmt --all"
fmt-check = "cargo fmt --all -- --check"
clippy = "cargo clippy --all-targets --all-features -- -D warnings"
lint = { depends-on = ["fmt-check", "clippy"] }
docs = "mkdocs serve"
docs-build = "mkdocs build"
dashboard-install = "cd dashboard && npm install"
dashboard-proto = { cmd = "cd dashboard && npm run proto", depends-on = ["dashboard-install"] }
dashboard = { cmd = "cd dashboard && npm run dev", depends-on = ["dashboard-proto", "bridge-build"] }
dashboard-build = { cmd = "cd dashboard && npm run build", depends-on = ["dashboard-proto"] }
pre-commit-install = "pre-commit install"
pre-commit-run = "pre-commit run --all-files"

# Zenoh bridge (for dashboard WebSocket connection)
bridge-clone = "test -d zenoh-ts || git clone https://github.com/eclipse-zenoh/zenoh-ts.git"
bridge-build = { cmd = "cd zenoh-ts/zenoh-bridge-remote-api && cargo build --release", depends-on = ["bridge-clone"] }
bridge = { cmd = "zenoh-ts/zenoh-bridge-remote-api/target/release/zenoh-bridge-remote-api --listen tcp/0.0.0.0:7448 --ws-port 10000", depends-on = ["bridge-build"] }

[dependencies]
# Rust toolchain
rust = ">=1.75"

# GLib/GIO (required by gstreamer-rs)
glib = ">=2.56"

# GStreamer core and plugins
gstreamer = ">=1.22"
gst-plugins-base = ">=1.22"
gst-plugins-good = ">=1.22"
gst-plugins-bad = ">=1.22"      # Contains h264parse
gst-plugins-ugly = ">=1.22"     # Contains x264enc
gst-libav = ">=1.22"            # Contains avdec_h264

# Build dependencies
pkg-config = ">=0.29"
cmake = ">=3.20"
zlib = ">=1.2"
protobuf = ">=3.20"          # protoc compiler for prost-build

# Documentation
mkdocs-material = ">=9.0"

# Development tools
pre-commit = ">=3.0"

# Dashboard
nodejs = ">=20"
